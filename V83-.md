## V83 - Cookies 

1. They allow us to preserve "state" of the web app.
2. Web server sends data to the browser which then saves it in a cookie
3. Browser sends cookie data with each future request to the web server

- Cookies in rails work just like a hash of the values.
- Assigning value to a cookie 
  ```
  cookies[:username] = "meetmak" 

  cookies[:username] = {
    :value => "meetmak",
    :expires => 1.week.from_now 
  ```

- Limitations :
  - Max data size : 4Kb (~4000 chars) and the rest chars will be ignored.
  - Resides on user's computer
  - User can delete, read or alter the cookies. So cookies cant be always trusted by the web server as it can be altered by the user.

- Advice on usage :
  - Use to preserve state and save time.
  - Store only small pieces of data
  - Don't store model instances
  - Don't store sensitive data. 

---
## V84 - Sessions 

1. Designed to address the problem of preserving state of the web app
2. eb server sends a session ID  to the browser, which then the browser saves the session ID in a cookie of the browser.
3. Browser sends session ID with each future request to the web server.
4. Then the web server uses this session ID to locate the session file.
5. The session file has the data we want to store/process.
6. Session ID is not browser side but a server side entity which cannot be altered by the users.

- Using sessions is similar to cookies like using hash of the values 
  ```
  session[:username] = "meetmak"
  ```

- Limitations :
  - Requires timme to retireve the file using the session identifier. On a busy high traffic server the retrieval time will be noticable.
  - Session files accumulate on the server over time and it is upto the programmer tjo delete the old ones.
  - Session cookie resides on user's computer so it can be delted/hijacked. Like if the session ID gets in the hands od hacker then hacker can present itself like the actual user.

- Session Storage 
  1. File storage 
  2. Databse storage
  3. Cookie storage ( since rails 3 and default since then)

- Rails cookie storage
  1. "Super cookies"
  2. Fast and no lookup needed
  3. No setup required
  4. No file/DB bloat
  5. These super cookies are sent to the user's browser.
  6. Encrypted to prevent reading
  7. Cryptographically Signed to prevent tampering.
  8. Max size of 4Kb
  
- If dont want to use cookie storage then configure it 

---
## V85 - Controller filters (Controller callbacks)


1. Allow us to execute the code before/after a controller action.
2. Filter request before allowing actions
3. Remove code repetition
4. Perfor "housekeeping" tasks.(Setup/cleanup)

Uses : 

1. Confirm user authentication 
2. Set variables & default values needed by the templates.
3. Find database objects
4. Get shopping cart 
   
Methods :

1. before_action
2. after_action
3. around_action

- Any render/redirect methods inside the action method will prevent it's execution.
- Specify which actions activaye the filter with :
  ```
  :only => [:method1, :method3]
  :except => [:method2]
  ```
- Any filters defined in the `ApplicationController` are iherited by all the controllers.
- * All of the controllers are inherited from the `ApplicationController` class.
- Inherited filters can be skipped.
  1. skip_beore_action
  2. skip_after_action
  3. skip_around_action 

 1. Added before_action in the pages_controller.rb  

---

## V86 - Logging (Application logs)

- Log files used by rails 
- Log level configuration will be in the `config/environmen/` filees 
  - default is the `:debug` level for development.rb
  - ![Log levels table](image.png)
- 5 log levels 
  1. `:debug` shows everything 
     1. errors
     2. deprecations
     3. render details about the templates 
     4. request details about the parameters that were sent 
     5. SQL which is composed.
  2. `:info` 
     1. Leaves the SQL part as it maybe a privacy concern 
  3. `:warn` 
     1. Only shows deprecations and errors ie. when things go wrong
  4. `:error` - shows recoverable errors
  5. `:fatal` - shows show stopping errors from recovering if not possible
  
- Can clear log files from the terminal using `rails log:clear` 
- Or can set up log rotations which automatically archives and clears the logs.
- Can write to the log files via the controller
```
logger.debug("The name is #(@subject.name}")

logger.info("Starting the subject update...") 

logger.warn("Invalid log in by #(params[:username]}") 

logger.error("Page #(params[:id]) not found") 

logger.fatal ("Necessary RubyGem not loaded")
```

Implementation :

1. Clear the log file by using the command `rails log:clear`.
2. Upon running the server, after doing some actions on the web app, corresponding logs are generated in that log file.
3. Changes config.log_level to `:warn` from `:debug`.
4. Tried adding a `loggr` to the subjectsController index def and the log was reflected succesfully in the console and log file.

##  V87 - Authentication 

1. Admin creates a user and password is encrypted by rails 
2. At login page, search for username in the DB and compare the password after encrypting with the encrypted password. 
3. Mark the user as authenticated 
   1. Set session variable as the user ID.
   2. Redirect user to post-logiin page 
4. User requests additional passwrod-protected pages, session data available will be used with each request. `before_action` control filter will be used for this check.
5. Logout - will set the userId stored inside the session variable to be NULL.

---
### V88 - Secure passwords 

1. Rails uses Blowfish encryption algorithm.
2. `has_secure_password` method of rails that we can put into any ActiveRecord model.
   1. Prequestes are the following before using this method :
      1. `bcyrpt`(blowfish) gem installed
      2. Tables must have a string column name "password_digest".

Implementation :

1. Uncommenting the line of bcrypt gem in the gemfile 
2. Creating a new migration for adding a new column of password_digest 
```
rails generate migration AddPasswordDigestToAdmin
```
3. Added up and down methods in that migration file and ran `rails db:migrate`.
4. Now a new column in the admin_users table has been added in the schema.rb
5. Just added one line `has_secure_password` in the admin_user.rb model.

### `has_secure_password`

Adds `attr_reader :password` for password that assigns a value to the password. ANd this password will be autommatically encrypted by the blowfish and set this hash equal to password_digest but not yet save it.
```
attr_reader :password

#so that no user can create an user without passsword
validates_presence_of :password, :create 
validates_confirmation_of :password

def authenticate(unencrypted_password)
  #... returns True/False on checking the DB password_digest matching
end
```

1. Start rails console 
2. ```
    user = AdminUser.first
    ```
3. Add a password for that user 
```
user.password = 'testpassword'
```
4. Then check the digest which will give the hash form.
```
irb(main):005:0> user.password_digest 
=> "$2a$12$vEXj5IzVitWCKvGqQschROcQiyhw/BUHSAz9wSbxwsp0929R93r9u"
```
5. Save the user 
```
user.save
```
6. Start the mysql console and check the column 
```
 mysql -u rails_user -p simple_cms_development
```
7. Authenticating and testing
```
irb(main):007:0> u = AdminUser.first
irb(main):008:0> u.authenticate("yooohahaha")
=> false
irb(main):009:0> u.authenticate("testpassword")
=> #<AdminUser id: 1, first_name: "Meet", last_name: "Makwana", username: "meeti678", email: "meet@meet.com", created_at: "2022-10-05 15:49:13", updated_at: "2022-10-08 11:22:00", password_digest: "$2a$12$vEXj5IzVitWCKvGqQschROcQiyhw/BUHSAz9wSbxwsp..."
```

---
## V89 - Create a contoller for access(login/logout) and login form 

1. Generate a controller with 2 templates `menu` and `login`.
```
rails generate controller Acess menu login 
```
2. Added routes in the routes.rb
3. Can use resourcefull routes naming by getting the prefixes of the routes by the command `rails routes` on the command line.
4. Populated the templates for menu and login.
5. Added layout keyword in the access_controller.rb
6. Tried the web app !
7. NOw skeleton for user authentication is ready consisting of 
   1. Routes needed
   2. controller
   3. view templates 